extends ../layout

block content
  h1 Case #{caseDetails.order}
  a.btn.btn-link(href='/ct') Back to dashboard
  if caseDetails.todos && caseDetails.todos.length
    .alert.alert-warning
      strong Attention needed:
      ul.mb-0
        each todo in caseDetails.todos
          li= todo
  .row.mt-3
    .col-md-6
      h2 Overview
      table.table.table-dark.table-sm.table-borderless
        tr
          th Scope
          td= caseDetails.type || '—'
        tr
          th Status
          td= caseDetails.status || '—'
        tr
          th Solution
          td= caseDetails.solution || '—'
        tr
          th Deadline
          td= caseDetails.deadline ? ((new Date(caseDetails.deadline)).toISOString().split('T')[0]) : '—'
        tr
          th Staff
          td= caseDetails.staff_in_charge || '—'
        tr
          th Tracking
          td= caseDetails.tracking || '—'
        tr
          th Shipping
          td= caseDetails.shipping_method || '—'
        tr
          th Customer
          td= caseDetails.customer_id || '—'
        tr
          th Country
          td= caseDetails.country || '—'
        tr
          th Started
          td= caseDetails.started ? ((new Date(caseDetails.started)).toISOString().split('T')[0]) : '—'
        tr
          th Ended
          td= caseDetails.ended ? ((new Date(caseDetails.ended)).toISOString().split('T')[0]) : '—'
    .col-md-6
      h2 Update case
      form(action=`/ct/case/${caseDetails.id}/update`, method='post')
        .mb-2
          label.form-label(for='status') Status
          select#status.form-select(name='status')
            each status in metadata.statuses
              option(value=status selected=caseDetails.status === status)= status
        .mb-2
          label.form-label(for='solution') Solution
          select#solution.form-select(name='solution')
            option(value='') -- None --
            each solution in metadata.solutions
              option(value=solution selected=caseDetails.solution === solution)= solution
        .mb-2
          label.form-label(for='deadline') Deadline
          input#deadline.form-control(type='date', name='deadline', value=caseDetails.deadline ? (new Date(caseDetails.deadline).toISOString().split('T')[0]) : '')
        .mb-2
          label.form-label(for='staff_in_charge') Staff in charge
          input#staff_in_charge.form-control(type='text', name='staff_in_charge', value=caseDetails.staff_in_charge || '')
        .mb-2
          label.form-label(for='tracking') Tracking number
          input#tracking.form-control(type='text', name='tracking', value=caseDetails.tracking || '')
        .mb-2
          label.form-label(for='shipping_method') Shipping method
          select#shipping_method.form-select(name='shipping_method')
            option(value='') -- Select --
            each method in metadata.shippingMethods
              option(value=method selected=caseDetails.shipping_method === method)= method
        .mb-2
          label.form-label(for='type') Case type
          select#type.form-select(name='type')
            option(value='') -- Select --
            each t in metadata.claimTypes
              option(value=t selected=caseDetails.type === t)= t
        .mb-2
          label.form-label(for='country') Country
          input#country.form-control(type='text', name='country', value=caseDetails.country || '')
        .mb-2
          label.form-label(for='cancel_reason') Cancellation reason
          select#cancel_reason.form-select(name='cancel_reason')
            option(value='') -- Not canceled --
            each reason in metadata.cancelReasons
              option(value=reason selected=caseDetails.cancel_reason === reason)= reason
        button.btn.btn-primary(type='submit') Save changes
  hr
  h2 Items
  if caseDetails.items && caseDetails.items.length
    table.table.table-dark.table-striped
      thead
        tr
          th Code
          th Issue
          th Value
          th
      tbody
        each item in caseDetails.items
          tr
            td= item.item_code
            td= item.defect || '—'
            td= item.item_cost ? `${item.item_cost} JPY` : '—'
            td.text-end
              button.btn.btn-sm.btn-outline-secondary(type='button', data-item=JSON.stringify(item)) Edit
              form.d-inline(action=`/ct/case/${caseDetails.id}/item/${item.id}/delete`, method='post')
                button.btn.btn-sm.btn-outline-danger(type='submit') Remove
  else
    p.text-muted No items recorded yet.
  h3.mt-3 Add or update item
  form#item-form(action=`/ct/case/${caseDetails.id}/item`, method='post')
    input#item_id(type='hidden', name='item_id')
    .row
      .col-md-4
        label.form-label(for='item_code') Item code
        input#item_code.form-control(type='text', name='item_code', required)
      .col-md-4
        label.form-label(for='item_defect') Issue
        input#item_defect.form-control(type='text', name='item_defect')
      .col-md-4
        label.form-label(for='item_cost') Value (JPY)
        input#item_cost.form-control(type='number', name='item_cost', min='0')
    .mt-2
      button.btn.btn-secondary(type='submit') Save item
      button#item-reset.btn.btn-link(type='button') Clear form
  hr
  h2 Comments
  if caseDetails.comments && caseDetails.comments.length
    ul.list-group.mb-3
      each comment in caseDetails.comments
        li.list-group-item
          small.text-muted #{comment.staff} on #{(new Date(comment.timestamp)).toISOString().split('T')[0]}
          p.mb-0(style="color:black;")= comment.comment
  else
    p.text-muted No comments yet.
  form(action=`/ct/case/${caseDetails.id}/comment`, method='post')
    .input-group
      input.form-control(type='text', name='comment', placeholder='Add a note', required)
      button.btn.btn-primary(type='submit') Post
  hr
  h2 Activity log
  if caseDetails.audits && caseDetails.audits.length
    ul.list-unstyled
      each entry in caseDetails.audits
        li.mb-2
          small.text-muted #{entry.staff} on #{(new Date(entry.timestamp)).toISOString().split('T')[0]}
          br
          span= entry.log
  else
    p.text-muted No recent activity logged.
  hr
  h2 Close case
  a.btn.btn-success.me-2(href=`/ct/case/${caseDetails.id}/close/complete`) Complete case
  a.btn.btn-outline-danger(href=`/ct/case/${caseDetails.id}/close/cancel`) Cancel case
  script(src='/js/ct/case.js')
