extends ../layout

block content
  h1 Case #{caseDetails.order}
  a.btn.btn-link(href='/ct') Back to dashboard
  if success
    .alert.alert-success Case details updated.
  if approved
    .alert.alert-success Approval recorded (#{approved}).
  if message
    .alert.alert-warning= message
  if caseDetails.todos && caseDetails.todos.length
    .alert.alert-warning
      strong Attention needed:
      ul.mb-0
        each todo in caseDetails.todos
          li= todo
  - const approvalStatus = caseDetails.approvalStatus || { required: {}, granted: {}, missing: [] }
  - const canApproveSecondary = staffPrivileges && (staffPrivileges.indexOf('secondary') !== -1 || staffPrivileges.indexOf('leader') !== -1)
  - const canApproveLeader = staffPrivileges && staffPrivileges.indexOf('leader') !== -1
  .row.mt-3
    .col-md-6
      h2 Overview
      table.table.table-dark.table-sm.table-borderless
        tr
          th Scope
          td= caseDetails.type || '—'
        tr
          th Status
          td= caseDetails.status || '—'
        tr
          th Solution
          td= caseDetails.solution || '—'
        tr
          th Deadline
          td= caseDetails.deadline ? ((new Date(caseDetails.deadline)).toISOString().split('T')[0]) : '—'
        tr
          th Staff
          td= caseDetails.staff_in_charge || '—'
        tr
          th Tracking
          td= caseDetails.tracking || '—'
        tr
          th Shipping
          td= caseDetails.shipping_method || '—'
        tr
          th Customer
          td
            if caseDetails.customer_id
              a(href=`/ct/customer/${encodeURIComponent(caseDetails.customer_id)}`)= caseDetails.customer_id
            else
              span —
        tr
          th Country
          td= caseDetails.country || '—'
        tr
          th Started
          td= caseDetails.started ? ((new Date(caseDetails.started)).toISOString().split('T')[0]) : '—'
        tr
          th Ended
          td= caseDetails.ended ? ((new Date(caseDetails.ended)).toISOString().split('T')[0]) : '—'
        tr
          th Customer cases
          td
            if caseDetails.customerSummary
              - const summary = caseDetails.customerSummary
              | #{summary.totalCases} total (open #{summary.openCases})
              if summary.defect
                | , defects #{summary.defect.total}
                if summary.defect.ongoing
                  |  (+#{summary.defect.ongoing} open)
            else
              span —
    .col-md-6
      h2 Update case
      form(action=`/ct/case/${caseDetails.id}/update`, method='post')
        .mb-2
          label.form-label(for='status') Status
          select#status.form-select(name='status')
            each status in metadata.statuses
              option(value=status selected=caseDetails.status === status)= status
        .mb-2
          label.form-label(for='solution') Solution
          select#solution.form-select(name='solution')
            option(value='') -- None --
            each solution in metadata.solutions
              option(value=solution selected=caseDetails.solution === solution)= solution
        .mb-2
          label.form-label(for='deadline') Deadline
          input#deadline.form-control(type='date', name='deadline', value=caseDetails.deadline ? (new Date(caseDetails.deadline).toISOString().split('T')[0]) : '')
        .mb-2
          label.form-label(for='staff_in_charge') Staff in charge
          input#staff_in_charge.form-control(type='text', name='staff_in_charge', value=caseDetails.staff_in_charge || '')
        .mb-2
          label.form-label(for='tracking') Tracking number
          input#tracking.form-control(type='text', name='tracking', value=caseDetails.tracking || '')
        .mb-2
          label.form-label(for='shipping_method') Shipping method
          select#shipping_method.form-select(name='shipping_method')
            option(value='') -- Select --
            each method in metadata.shippingMethods
              option(value=method selected=caseDetails.shipping_method === method)= method
        .mb-2
          label.form-label(for='type') Case type
          select#type.form-select(name='type')
            option(value='') -- Select --
            each t in metadata.claimTypes
              option(value=t selected=caseDetails.type === t)= t
        .mb-2
          label.form-label(for='country') Country
          input#country.form-control(type='text', name='country', value=caseDetails.country || '')
        .mb-2
          label.form-label(for='cancel_reason') Cancellation reason
          select#cancel_reason.form-select(name='cancel_reason')
            option(value='') -- Not canceled --
            each reason in metadata.cancelReasons
              option(value=reason selected=caseDetails.cancel_reason === reason)= reason
        button.btn.btn-primary(type='submit') Save changes
  if approvalStatus.missing && approvalStatus.missing.length
    .alert.alert-danger
      strong Approval required:
      ul.mb-0
        each item in approvalStatus.missing
          li= item
  if (caseDetails.approvals && caseDetails.approvals.length) || (approvalStatus.required.secondary || approvalStatus.required.leader)
    h2 Approvals
    if caseDetails.approvals && caseDetails.approvals.length
      table.table.table-dark.table-striped
        thead
          tr
            th Type
            th Approved by
            th Timestamp
        tbody
          each approval in caseDetails.approvals
            tr
              td= approval.approval_type
              td= approval.approved_by || '—'
              td= approval.updatedAt ? (new Date(approval.updatedAt).toISOString().split('T')[0]) : '—'
    if approvalStatus.required.secondary && !approvalStatus.granted.secondary
      if canApproveSecondary
        form.d-inline(action=`/ct/case/${caseDetails.id}/approve`, method='post', class='me-3')
          input(type='hidden', name='approval_type', value='secondary')
          button.btn.btn-warning(type='submit') Record secondary approval
      else
        p.text-muted Secondary approval pending — approver required.
    if approvalStatus.required.leader && !approvalStatus.granted.leader
      if canApproveLeader
        form.d-inline(action=`/ct/case/${caseDetails.id}/approve`, method='post')
          input(type='hidden', name='approval_type', value='leader')
          button.btn.btn-danger(type='submit') Record leader approval
      else
        p.text-muted Leader approval pending — management only.
  h2 Zendesk
  if caseDetails.tickets && caseDetails.tickets.length
    table.table.table-dark.table-striped
      thead
        tr
          th Ticket
          th Added
      tbody
        each ticket in caseDetails.tickets
          tr
            td
              a(href=`https://ohami.zendesk.com/agent/tickets/${ticket.ticket}`, target='_blank')= ticket.ticket
            td= ticket.createdAt ? (new Date(ticket.createdAt).toISOString().split('T')[0]) : '—'
  else
    p.text-muted No Zendesk tickets linked yet.
  form(action=`/ct/case/${caseDetails.id}/ticket`, method='post', class='mb-4')
    .input-group
      input.form-control(type='number', name='ticket', placeholder='Zendesk ticket number', required)
      button.btn.btn-outline-primary(type='submit') Link ticket
  h2 Items
  if caseDetails.items && caseDetails.items.length
    table.table.table-dark.table-striped
      thead
        tr
          th Code
          th Issue
          th Value
          th
      tbody
        each item in caseDetails.items
          tr
            td
              if item.item_code
                a(href=`/ct/item/${encodeURIComponent(item.item_code)}`)= item.item_code
              else
                span —
            td= item.defect || '—'
            td= item.item_cost ? `${item.item_cost} JPY` : '—'
            td.text-end
              button.btn.btn-sm.btn-outline-secondary(type='button', data-item=JSON.stringify(item)) Edit
              form.d-inline(action=`/ct/case/${caseDetails.id}/item/${item.id}/delete`, method='post')
                button.btn.btn-sm.btn-outline-danger(type='submit') Remove
  else
    p.text-muted No items recorded yet.
  h3.mt-3 Add or update item
  form#item-form(action=`/ct/case/${caseDetails.id}/item`, method='post')
    input#item_id(type='hidden', name='item_id')
    .row
      .col-md-4
        label.form-label(for='item_code') Item code
        input#item_code.form-control(type='text', name='item_code', required)
      .col-md-4
        label.form-label(for='item_defect') Issue
        input#item_defect.form-control(type='text', name='item_defect')
      .col-md-4
        label.form-label(for='item_cost') Value (JPY)
        input#item_cost.form-control(type='number', name='item_cost', min='0')
    .mt-2
      button.btn.btn-secondary(type='submit') Save item
      button#item-reset.btn.btn-link(type='button') Clear form
  h2 Comments
  if caseDetails.comments && caseDetails.comments.length
    table.table.table-dark.table-striped
      thead
        tr
          th Staff
          th Date
          th Comment
      tbody
        each comment in caseDetails.comments
          tr
            td= comment.staff || '—'
            td= comment.timestamp ? (new Date(comment.timestamp)).toISOString().split('T')[0] : '—'
            td= comment.comment
  else
    p.text-muted No comments yet.
  form(action=`/ct/case/${caseDetails.id}/comment`, method='post', class='mb-4')
    .input-group
      input.form-control(type='text', name='comment', placeholder='Add a note', required)
      button.btn.btn-primary(type='submit') Post
  h2 Activity log
  if caseDetails.audits && caseDetails.audits.length
    table.table.table-dark.table-striped
      thead
        tr
          th Staff
          th Date
          th Entry
      tbody
        each entry in caseDetails.audits
          tr
            td= entry.staff || '—'
            td= entry.timestamp ? (new Date(entry.timestamp)).toISOString().split('T')[0] : '—'
            td= entry.log
  else
    p.text-muted No recent activity logged.
  h2 Close case
  a.btn.btn-success.me-2(href=`/ct/case/${caseDetails.id}/close/complete`) Complete case
  a.btn.btn-outline-danger(href=`/ct/case/${caseDetails.id}/close/cancel`) Cancel case
  script(src='/js/ct/case.js')
